<!DOCTYPE html>
<meta charset="utf-8">
<style>

.node {
  font: 350 5.5px "Helvetica Neue", Helvetica, Arial, sans-serif;
  fill: gray;
}

.node:hover {
  fill: #d62728;
}

.link {
  stroke: lightsteelblue;
  stroke-opacity: 0.3;
  fill: none;
  pointer-events: none;
}

.node:hover,
.node--source,
.node--target {
  font-weight: 400;
}


.node--source {
  /* fill: #2ca02c; */
  fill: #d62728;
}

.node--target {
  fill: #d62728;
    font-size: 15px;

}
.node--clicked {
  /* fill: #2ca02c; */
  fill: #d62728;
  font-weight: 700;
    font-size: 15px;
}

.link--source,
.link--target {
  stroke-opacity: 0.9;
  stroke-width: 1.3px;
}

.link--source {
  stroke: #d62728;
}

.link--target {
  /* stroke: #2ca02c; */
  stroke: #d62728;
}

</style>
<body>
<script src="https://d3js.org/d3.v4.min.js"></script>
<input type='checkbox' id='CERTAIN CONDITIONS ORIGINATING IN THE PERINATAL PERIOD ' checked='checked'/> CERTAIN CONDITIONS ORIGINATING IN THE PERINATAL PERIOD <br/>
<input type='checkbox' id='COMPLICATIONS OF PREGNANCY, CHILDBIRTH, AND THE PUERPERIUM ' checked='checked'/> COMPLICATIONS OF PREGNANCY, CHILDBIRTH, AND THE PUERPERIUM <br/>
<input type='checkbox' id='DISEASES OF THE CIRCULATORY SYSTEM ' checked='checked'/> DISEASES OF THE CIRCULATORY SYSTEM <br/>
<input type='checkbox' id='DISEASES OF THE DIGESTIVE SYSTEM ' checked='checked'/> DISEASES OF THE DIGESTIVE SYSTEM <br/>
<input type='checkbox' id='DISEASES OF THE GENITOURINARY SYSTEM ' checked='checked'/> DISEASES OF THE GENITOURINARY SYSTEM <br/>
<input type='checkbox' id='DISEASES OF THE MUSCULOSKELETAL SYSTEM AND CONNECTIVE TISSUE ' checked='checked'/> DISEASES OF THE MUSCULOSKELETAL SYSTEM AND CONNECTIVE TISSUE <br/>
<input type='checkbox' id='DISEASES OF THE NERVOUS SYSTEM AND SENSE ORGANS ' checked='checked'/> DISEASES OF THE NERVOUS SYSTEM AND SENSE ORGANS <br/>
<input type='checkbox' id='DISEASES OF THE RESPIRATORY SYSTEM ' checked='checked'/> DISEASES OF THE RESPIRATORY SYSTEM <br/>
<input type='checkbox' id='DISEASES OF THE SKIN AND SUBCUTANEOUS TISSUE ' checked='checked'/> DISEASES OF THE SKIN AND SUBCUTANEOUS TISSUE <br/>
<input type='checkbox' id='DRUGS, MEDICINAL AND BIOLOGICAL SUBSTANCES CAUSING ADVERSE EFFECTS IN THERAPEUTIC USE ' checked='checked'/> DRUGS, MEDICINAL AND BIOLOGICAL SUBSTANCES CAUSING ADVERSE EFFECTS IN THERAPEUTIC USE <br/>
<input type='checkbox' id='ENDOCRINE, NUTRITIONAL AND METABOLIC DISEASES, AND IMMUNITY DISORDERS ' checked='checked'/> ENDOCRINE, NUTRITIONAL AND METABOLIC DISEASES, AND IMMUNITY DISORDERS <br/>
<input type='checkbox' id='INFECTIOUS AND PARASITIC DISEASES ' checked='checked'/> INFECTIOUS AND PARASITIC DISEASES <br/>
<input type='checkbox' id='INJURY AND POISONING ' checked='checked'/> INJURY AND POISONING <br/>
<input type='checkbox' id='LIVEBORN INFANTS ACCORDING TO TYPE OF BIRTH ' checked='checked'/> LIVEBORN INFANTS ACCORDING TO TYPE OF BIRTH <br/>
<input type='checkbox' id='MENTAL DISORDERS ' checked='checked'/> MENTAL DISORDERS <br/>
<input type='checkbox' id='NEOPLASMS ' checked='checked'/> NEOPLASMS <br/>
<input type='checkbox' id='NONSPECIFIC ABNORMAL FINDINGS ' checked='checked'/> NONSPECIFIC ABNORMAL FINDINGS <br/>
<input type='checkbox' id='Other ill-defined and unknown causes of morbidity and mortality' checked='checked'/> Other ill-defined and unknown causes of morbidity and mortality<br/>
<input type='checkbox' id='PERSONS ENCOUNTERING HEALTH SERVICES FOR SPECIFIC PROCEDURES AND AFTERCARE ' checked='checked'/> PERSONS ENCOUNTERING HEALTH SERVICES FOR SPECIFIC PROCEDURES AND AFTERCARE <br/>
<input type='checkbox' id='PERSONS WITH A CONDITION INFLUENCING THEIR HEALTH STATUS ' checked='checked'/> PERSONS WITH A CONDITION INFLUENCING THEIR HEALTH STATUS <br/>
<input type='checkbox' id='PERSONS WITH POTENTIAL HEALTH HAZARDS RELATED TO PERSONAL AND FAMILY HISTORY ' checked='checked'/> PERSONS WITH POTENTIAL HEALTH HAZARDS RELATED TO PERSONAL AND FAMILY HISTORY <br/>
<input type='checkbox' id='PERSONS WITH POTENTIAL HEALTHHAZARDS RELATED TO COMMUNICABLE DISEASES ' checked='checked'/> PERSONS WITH POTENTIAL HEALTHHAZARDS RELATED TO COMMUNICABLE DISEASES <br/>
<input type='checkbox' id='PLACE OF OCCURENCE ' checked='checked'/> PLACE OF OCCURENCE <br/>
<input type='checkbox' id='SURGICAL AND MEDICAL PROCEDURES AS THE CAUSE …MENTION OF MISADVENTURE AT THE TIME OF PROCEDURE ' checked='checked'/> SURGICAL AND MEDICAL PROCEDURES AS THE CAUSE …MENTION OF MISADVENTURE AT THE TIME OF PROCEDURE <br/>
<input type='checkbox' id='SYMPTOMS ' checked='checked'/> SYMPTOMS <br/>
<input type='checkbox' id='Suicide and self-inflicted poisoning by solid or liquid substances' checked='checked'/> Suicide and self-inflicted poisoning by solid or liquid substances<br/>
<script>

var checked = Array(
                    "CERTAIN CONDITIONS ORIGINATING IN THE PERINATAL PERIOD ",
                    "COMPLICATIONS OF PREGNANCY, CHILDBIRTH, AND THE PUERPERIUM ",
                    "DISEASES OF THE CIRCULATORY SYSTEM ",
                    "DISEASES OF THE DIGESTIVE SYSTEM ",
                    "DISEASES OF THE GENITOURINARY SYSTEM ",
                    "DISEASES OF THE MUSCULOSKELETAL SYSTEM AND CONNECTIVE TISSUE ",
                    "DISEASES OF THE NERVOUS SYSTEM AND SENSE ORGANS ",
                    "DISEASES OF THE RESPIRATORY SYSTEM ",
                    "DISEASES OF THE SKIN AND SUBCUTANEOUS TISSUE ",
                    "DRUGS, MEDICINAL AND BIOLOGICAL SUBSTANCES CAUSING ADVERSE EFFECTS IN THERAPEUTIC USE ",
                    "ENDOCRINE, NUTRITIONAL AND METABOLIC DISEASES, AND IMMUNITY DISORDERS ",
                    "INFECTIOUS AND PARASITIC DISEASES ",
                    "INJURY AND POISONING ",
                    "LIVEBORN INFANTS ACCORDING TO TYPE OF BIRTH ",
                    "MENTAL DISORDERS ",
                    "NEOPLASMS ",
                    "NONSPECIFIC ABNORMAL FINDINGS ",
                    "Other ill-defined and unknown causes of morbidity and mortality",
                    "PERSONS ENCOUNTERING HEALTH SERVICES FOR SPECIFIC PROCEDURES AND AFTERCARE ",
                    "PERSONS WITH A CONDITION INFLUENCING THEIR HEALTH STATUS ",
                    "PERSONS WITH POTENTIAL HEALTH HAZARDS RELATED TO PERSONAL AND FAMILY HISTORY ",
                    "PERSONS WITH POTENTIAL HEALTHHAZARDS RELATED TO COMMUNICABLE DISEASES ",
                    "PLACE OF OCCURENCE ",
                    "SURGICAL AND MEDICAL PROCEDURES AS THE CAUSE …MENTION OF MISADVENTURE AT THE TIME OF PROCEDURE ",
                    "SYMPTOMS ",
                    "Suicide and self-inflicted poisoning by solid or liquid substances"
                    );

var diameter = 850,
    radius = diameter / 2,
    innerRadius = radius - 240;

var cluster = d3.cluster()
    .size([360, innerRadius])
    .separation(function(a, b) {
      a_parent = [];
      b_parent = [];
      while (a.parent) {
        a_parent.unshift(a.data.name);
        a = a.parent;
      };
      while (b.parent) {
        b_parent.unshift(b.data.name);
        b = b.parent;
      };
      if (checked.includes(a_parent[0])) {
        if (checked.includes(b_parent[0])) {
          if (checked.length === 1) { 
            return a_parent[1] === b_parent[1] ? 1 : 3; 
          } else { 
            return a_parent[0] === b_parent[0] ? 1 : 2; 
          }
        } else {
          return 1;
        }
      } else {
        if (checked.includes(b_parent[0])) {
          return 1;
        } else {
          return 0;
        }
      }
    });

var line = d3.radialLine()
    .curve(d3.curveBundle.beta(0.85))
    .radius(function(d) { return d.y; })
    .angle(function(d) { return d.x / 180 * Math.PI; });

var svg = d3.select("body").append("svg")
    .attr("width", diameter)
    .attr("height", diameter)
  .append("g")
    .attr("transform", "translate(" + radius + "," + radius + ")");

var link = svg.append("g").selectAll(".link"),
    node = svg.append("g").selectAll(".node");

function drawscene(data) {
  var kids = [];

  data.children.forEach(function(d) {
    if (checked.includes(d.data.name)) {
      d.descendants().forEach(function(c) {
        kids.push(c);
      });
    } 
  });

  // Create d3 cluster graph
  cluster(data);

  // Edges
  link = link
    .data(packageImports(kids))
    .enter().append("path")
      .each(function(d) { d.source = d[0], d.target = d[d.length - 1]; })
      .attr("class", "link")
      .attr("d", line);

  // Nodes
  node = node
    .data(kids)
    .enter().append("text")
      .attr("class", "node")
      .attr("dy", "0.31em")
      .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + (d.y + 8) + ",0)" + (d.x < 180 ? "" : "rotate(180)"); })
      .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
      .text(function(d) { 
        if (d.height<1) {return d.data.key; }
      else {return "";}})
      .on("mouseover", mouseovered)
      .on("mouseout", mouseouted)
      .on("click",clicked);
}

function changescene(data) {
  var kids = [];

  data.children.forEach(function(d) {
    if (checked.includes(d.data.name)) {
      d.descendants().forEach(function(c) {
        kids.push(c);
      });
    } 
  });

  // Create d3 cluster graph
  cluster(data);

  // Edges
  link = svg.selectAll(".link").data(packageImports(kids));
  link.enter()
      .append("path")
      .each(function(d) { d.source = d[0], d.target = d[d.length - 1]; })
      .attr("class", "link")
      .attr("d", line);
  link.transition()
      .each(function(d) { d.source = d[0], d.target = d[d.length - 1]; })
      .attr("class", "link")
      .attr("d", line);
  link.exit().remove();

  // Nodes
  node = svg.selectAll(".node").data(kids);
  node.enter()
      .append("text")
      .attr("class", "node")
      .attr("dy", "0.31em")
      .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + (d.y + 8) + ",0)" + (d.x < 180 ? "" : "rotate(180)"); })
      .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
      .text(function(d) { 
        if (d.height<1) {return d.data.key; }
      else {return "";}})
      .on("mouseover", mouseovered)
      .on("mouseout", mouseouted)
      .on("click",clicked);
  node.transition()
      .attr("class", "node")
      .attr("dy", "0.31em")
      .attr("transform", function(d) { return "rotate(" + (d.x - 90) + ")translate(" + (d.y + 8) + ",0)" + (d.x < 180 ? "" : "rotate(180)"); })
      .attr("text-anchor", function(d) { return d.x < 180 ? "start" : "end"; })
      .text(function(d) { 
        if (d.height<1) {return d.data.key; }
      else {return "";}});
  node.exit().remove();
}

function mouseovered(d) {
  node
      .each(function(n) { if (n.clicked) {} else {n.target = n.source = false; }});

  link
      .classed("link--target", function(l) { if ((l.target === d) || (l.target.clicked || l.source.clicked)) 
        return l.target.target = true; })
      .classed("link--source", function(l) { if ((l.source === d) || (l.target.clicked || l.source.clicked)) 
      return l.source.source = true; })
    .filter(function(l) { return l.target === d || l.source === d || l.target.clicked || l.source.clicked; })
      .raise();

  node
      .classed("node--target", function(n) {
        // if (n.clicked) {return false;}
        // else 
        {return n.target; }})
      .classed("node--source", function(n) {
        // if (n.clicked) {return false;}
        // else 
        {return n.source; }});
}

function mouseouted(d) {
  link
      .classed("link--target", function(l) {if (l.target===d) {return l.target.target=false;}})
      .classed("link--source", function(l) {if (l.source===d) {return l.source.source=false;}})
      .classed("link--target", function(l) {if (l.target.clicked || l.source.clicked) {return l.target.target=true;}})
      .classed("link--source", function(l) {if (l.target.clicked || l.source.clicked) {return l.source.source=true;}});

  node //function(d) {d.clicked;}
      .classed("node--target", function(l) {return l.target;})
      .classed("node--source", function(l) {return l.source;});
}

function clicked(d) {
  //console.log(d);
  if (d.clicked) {
    d.clicked = 0;
    mouseouted(d);
  }
  else {
    d.clicked = 1;
    mouseovered(d);
  }
  node
    .classed("node--clicked", function(n) {return n.clicked;});

}


// Lazily construct the package hierarchy from class names.
function packageHierarchy(classes) {
  var map = {};

  function find(name, data) {
    var node = map[name], i;
    if (!node) {
      if (data) {
        data.children = [];
        node = map[name] = data;
      }
      else {
        node = map[name] = {name: name, children: []};
      }
      //node = map[name] = data || {name: name, children: []};
      if (name.length) {
        //console.log(name);
        node.parent = find(name.substring(0, i = name.lastIndexOf(".")));
        //console.log(node.parent);
        node.parent.children.push(node);
        node.key = name.substring(i + 1);
      }
    }
    return node;
  }

  classes.forEach(function(d) {
    find(d.name, d);
  });

  return d3.hierarchy(map[""]);
}

// Return a list of imports for the given array of nodes.
function packageImports(nodes) {
  var map = {},
      imports = [];

  // Compute a map from name to node.
  nodes.forEach(function(d) {
    map[d.data.name] = d;
  });

  // For each import, construct a link from the source to target node.
  nodes.forEach(function(d) {
    if (d.data.imports) d.data.imports.forEach(function(i) {
      //console.log(i);
      //console.log(map[i]);
      if (map[i] != undefined) {
        imports.push(map[d.data.name].path(map[i]));
      }
    });
  });

  return imports;
}

function toggleCheckbox(changed,data) {
  
  if (changed.checked) {
    checked.push(changed.id);
  } else {
    index = checked.indexOf(changed.id);
    checked.splice(index, 1);
  }
  changescene(data);
}

function setupButtons(data) {
  checked.forEach(function(d) {
    document.getElementById(d).addEventListener('change', function() {toggleCheckbox(this,data);});
  });
  //document.getElementById('0').addEventListener('change', function() {toggleCheckbox(this,data);});
  //document.getElementById('1').addEventListener('change', function() {toggleCheckbox(this,data);});
  //document.getElementById('2').addEventListener('change', function() {toggleCheckbox(this,data);});
  //document.getElementById('3').addEventListener('change', function() {toggleCheckbox(this,data);});
  //document.getElementById('4').addEventListener('change', function() {toggleCheckbox(this,data);});
  //document.getElementById('5').addEventListener('change', function() {toggleCheckbox(this,data);});
  //document.getElementById('6').addEventListener('change', function() {toggleCheckbox(this,data);});
  //document.getElementById('7').addEventListener('change', function() {toggleCheckbox(this,data);});
  //document.getElementById('9').addEventListener('change', function() {toggleCheckbox(this,data);});
  //document.getElementById('E').addEventListener('change', function() {toggleCheckbox(this,data);});
  //document.getElementById('V').addEventListener('change', function() {toggleCheckbox(this,data);});
}

function main(data) {
  drawscene(data);
  setupButtons(data);
}

d3.json("hiernet.json", function(error, classes) {
  if (error) throw error;

  // Build package hierarchy as tree, accessed by root node
  var root = packageHierarchy(classes)
      .sum(function(d) { return d.size; });

  main(root);
});

</script>
