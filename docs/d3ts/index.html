<head>
<script src="https://d3js.org/d3.v4.js"></script>
<script src="d3.v4.js"></script>
<script src="d3_timeseries.js"></script>
<script src="sortable.js"></script>
<link href="app.css" rel="stylesheet" type="text/css"/>
</head>

<body onload="window.resizeTo(640,480)">
<ul id="vitals_divs" class="block__list block__list_words">
    <li><div id="chart0"></div></li>
    <li><div id="chart1"></div></li>
    <li><div id="chart2"></div></li>
    <li><div id="chart6"></div></li>
    <li><div id="chart3"></div></li>
    <li><div id="chart4"></div></li>
    <li><div id="chart5"></div></li> 
    <li><div id="chart7"></div></li>
</ul>
<div id="bottomButton">
    <button type='button' id='resetAllButton' onclick=restore()>Restore All Defaults</button>
</div>

<script>
    var vitals_divs = document.getElementById("vitals_divs");
    Sortable.create(vitals_divs);
</script>

<script>
var numDivs = 8;
//var data = createRandomData(600,[1000,1000000])
// [{date:new Date('2013-01-01'),n:120,n2:200}]
charts = [];
//var dsets = [[],[],[],[],[],[]];
names = ["II","V5","SpO2","Art","BP","ETCO2","QRS","ST","QT","PR"];
interval = 1000.0/60;
var data = [];
var sums = [];

d3.csv("data/alldata.csv")
    .row(function(d) {return {date: new Date((+d.date)*interval),
        II: +d.II, V5: +d.V5, SpO2: +d.SpO2, Art: +d.Art, BP: +d.BP, ETCO2: +d.ETCO2, QRS: +d.QRS, ST: +d.ST, QT: +d.QT, PR: +d.PR};})
    .get(function(error, rows){getSummaries(rows);})

function restore() {
    for (var i=0; i<numDivs; i++) {
        var curr_chart_div = document.getElementById('chart'+i.toString());
        while (curr_chart_div.firstChild) {
            curr_chart_div.removeChild(curr_chart_div.firstChild);
        };
    };
    data = [];
    sums = [];
    d3.csv("data/alldata.csv")
        .row(function(d) {return {date: new Date((+d.date)*interval),
            II: +d.II, V5: +d.V5, SpO2: +d.SpO2, Art: +d.Art, BP: +d.BP, ETCO2: +d.ETCO2, QRS: +d.QRS, ST: +d.ST, QT: +d.QT, PR: +d.PR};})
        .get(function(error, rows){getSummaries(rows);})
}

function drawEmpty(box) {
    var button_div = document.createElement('div');
    button_div.setAttribute('id', 'button_div');
    button_div.innerHTML = 
        "<img src=\"images/4way.svg\" height=\"50\" width=\"30\" style=\"margin-bottom:-15 \"></img></br>"+ 
        `<button type='button' onclick=addElement('II',${box})>View EKG II</button>&nbsp&nbsp&nbsp&nbsp`+
        `<button type='button' onclick=addElement('V5',${box})>View EKG V5</button>&nbsp&nbsp&nbsp&nbsp`+
        `<button type='button' onclick=addElement('SpO2',${box})>View SpO2</button>&nbsp&nbsp&nbsp&nbsp`+
        `<button type='button' onclick=addElement('Art',${box})>View Art</button>&nbsp&nbsp&nbsp&nbsp`+
        `<button type='button' onclick=addElement('BP',${box})>View BP</button>&nbsp&nbsp&nbsp&nbsp`+
        `<button type='button' onclick=addElement('ETCO2',${box})>View ETCO2</button>&nbsp&nbsp&nbsp&nbsp`+
        `<button type='button' onclick=addElement('QRS',${box})>View QRS</button>&nbsp&nbsp&nbsp&nbsp`+
        `<button type='button' onclick=addElement('ST',${box})>View ST</button>&nbsp&nbsp&nbsp&nbsp`+
        `<button type='button' onclick=addElement('QT',${box})>View QT</button>&nbsp&nbsp&nbsp&nbsp`+
        `<button type='button' onclick=addElement('PR',${box})>View PR</button>`;
    document.getElementById('chart'+box.toString()).appendChild(button_div);
}

function redrawWindow(box) {
    var curr_chart_div = document.getElementById('chart'+box.toString());
    while (curr_chart_div.firstChild) {
        curr_chart_div.removeChild(curr_chart_div.firstChild);
    };
    if (box<6) {
        addElement(names[box], box);
    }
    else {
        drawEmpty(box);
    }
}

function getSummaries(rows) {
    d3.csv("data/allsummary.csv")
        .row(function(d) {return {date: new Date((+d.date)*interval),
            II: +d.II, V5: +d.V5, SpO2: +d.SpO2, Art: +d.Art, BP: +d.BP, ETCO2: +d.ETCO2, QRS: +d.QRS, ST: +d.ST, QT: +d.QT, PR: +d.PR};})
        .get(function(error, summaries){buildPlot(rows,summaries);})
}

function addElement(element, box) {
    var chart = d3_timeseries()
        .addSerie(data, {x:'date',y:element},{interpolate:'linear'})
        .addSum(sums, {x:'date',y:element},{interpolate:'step'})
        //.addSerie(null,{x:'date',y:'n2'},
        //           {interpolate:'linear'})
        .margin.left(35)
        .width(360)
        .height(155);
    charts.push(chart);
    
    if (box>=6){
        var curr_chart_div = document.getElementById('chart'+box.toString());
        curr_chart_div.removeChild(curr_chart_div.childNodes.item("button_div"));
    };

    var i = names.indexOf(element);
    var label_div = document.createElement('div');
    label_div.setAttribute("id", "label_div");
    console.log(sums[15][element])
    label_div.innerHTML =
        "<img src=\"images/4way.svg\" height=\"30\" width=\"30\" style=\"margin-bottom:-15 \"></img>"+ 
        "<h4>"+element+"</h4>"+
        `<p>${sums[15][element]}</p>`;
    document.getElementById('chart'+box.toString()).appendChild(label_div);
    
    var graph_div = document.createElement('div');
    graph_div.setAttribute("id", "graph_div");
    chart(graph_div);
    document.getElementById('chart'+box.toString()).appendChild(graph_div);
    
    var notes_div = document.createElement('div');
    notes_div.setAttribute("id", "notes_div");
    //notes_div.innerHTML = `<p>hi</p>`;
    var reset_buttons_div = document.createElement('div');
    reset_buttons_div.setAttribute("id", "reset_buttons");
    reset_buttons_div.innerHTML = `<button type='button' onclick=redrawWindow(${box})>Reset</button>&nbsp&nbsp&nbsp&nbsp`;
    notes_div.appendChild(reset_buttons_div);
    document.getElementById('chart'+box.toString()).appendChild(notes_div);
}

function buildPlot(rows,summaries) {
    //console.log(data);
    rows.forEach(function(r) {data.push(r);});
    //console.log(data);
    //console.log(sums);
    summaries.forEach(function(r) {sums.push(r);});
    console.log(sums);
    for (var i=0; i<numDivs; i++)
    {
        if (i<6) {
            addElement(names[i], i);
        }
        else {
            drawEmpty(i);
        }
    }
}

</script>
</body>